var getURLQuery=function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)"),i=t.exec(location.search);return null===i?"":decodeURIComponent(i[1].replace(/\+/g," "))},API=function(){var e="http://127.0.0.1:8888",t="http://api.vgee.cn",i="true"==getURLQuery("debug")?e:t;return{get:i+"/msg",post:i+"/msg",del:i+"/msg",policy:i+"/policy"}}(),checkPageMode=function(){"true"==getURLQuery("del")&&($('input[type="checkbox"]').show(),$(".go-del").show().click(function(){deleteMessages()}))},deleteMessages=function(){var e=function(){var e=[];return $('input[type="checkbox"]').each(function(t,i){1==i.checked&&e.push(i.value)}),console.log(e),e},t=function(){$.ajax({url:API.del,type:"DELETE",data:{ids:e().join(",")}}).success(function(e){return 1!=e.flag?void alert("delete fail"):void window.location.reload()})};t()},icons={"01":"&#xe604;","02":"&#xe603;","03":"&#xe606;","04":"&#xe601;","09":"&#xe600;",10:"&#xe607;",11:"&#xe602;",13:"&#xe608;",50:"&#xe605;"},DATA_LOADING=!1,CURRECT_PAGE=1,getData=function(e,t){DATA_LOADING=!0,$(".loading").show();var i=[];$.getJSON(API.get,{page:e||1,count:t||5}).success(function(e){return 1!=e.flag?void alert("服务器发生了一个错误，请联系贝爷"):(CURRECT_PAGE++,e=e.data,$.each(e,function(e,t){t.first&&(t.message=t.first+"\n\n"+t.sec),t.city||(t.city="未知"),t.weither||(t.weither="未知");var c=function(e){return e=10>e?"0"+e:e},n=new Date(t.createdAt);n=n.getMonth()+1+"/"+n.getDate()+" "+c(n.getHours())+":"+c(n.getMinutes());var a=icons[t.weither_icon]||"&#xe604;",o="";t.img?"static"==t.img.slice(7,13)||"7xp0x5"==t.img.slice(7,13)?t.img+="?imageView2/2/w/500/interlace/0/q/90":t.img+="?x-oss-process=image/resize,w_500":o="no-img";var s=t.message.replace(/\/_rt\//g,"\n"),l=['<div class="container '+o+'">','<div class="pic-ct">','<img class="lazy" src="'+t.img+'" alt="">',"</div>",'<div class="text-ct">',"<pre>"+s+"</pre>",'<p class="user">-- <span>'+t.author+"</span></p>",'<div class="acts">','<div class="act">','<i class="iconfont">'+a+"</i>    ","<p>"+t.weither+"</p>","</div>",'<div class="act">','<i class="iconfont">&#xe60b;</i>',"<p>"+n+"</p>","</div>",'<div class="act">','<i class="iconfont location">&#xe60c;</i>',"<p>"+t.city+"</p>","</div>",'<input style="display:none" value="'+t._id+'" type="checkbox">',"</div>","</div>","</div>"];l=l.join("\n"),i.push(l)}),$(".big-ct").append(i.join("\n")),void checkPageMode())}).always(function(){DATA_LOADING=!1,$(".loading").hide()})};$(function(){$(window).on("scroll",function(){!DATA_LOADING&&$("body").scrollTop()>=$("body").height()-$(window).height()&&getData(CURRECT_PAGE)}),getData(CURRECT_PAGE)});