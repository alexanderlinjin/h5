var weitherAPI="http://api.openweathermap.org/data/2.5/weather?appid=ddd22c249a580fc203705e7412883979&lang=zh&callback=?&q=",transitionend="transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",getURLQuery=function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)"),i=t.exec(location.search);return null===i?"":decodeURIComponent(i[1].replace(/\+/g," "))},API=function(){var e="http://127.0.0.1:8888",t="http://api.vgee.cn",i="true"==getURLQuery("debug")?e:t;return{get:i+"/msg",post:i+"/msg",policy:i+"/policy",mylocation:i+"/mylocation"}}(),icons={"01":"&#xe604;","02":"&#xe603;","03":"&#xe606;","04":"&#xe601;","09":"&#xe600;",10:"&#xe607;",11:"&#xe602;",13:"&#xe608;",50:"&#xe605;"},PICS=20,userData={};$.fn.toShow=function(){return $(this).removeClass("hide").addClass("show")},$.fn.toHide=function(){return $(this).removeClass("show").addClass("hide")};var loadUserMsg=function(e){var t=new Date;userData.message=$(".edit #msg").val(),userData.time=t.getMonth()+1+"/"+t.getDate()+" "+t.getHours()+":"+t.getMinutes(),$.get(API.mylocation).success(function(t){if(1!=t.flag)return void(userData.city="未知");userData.city=t.data.location.city;var i=weitherAPI+userData.city;$.getJSON(i).success(function(e){return"404"==e.cod?(userData.temp=0,void(userData.weither="未知")):(userData.temp=(e.main.temp-273.15).toFixed(0),userData.weither=e.weather[0].description,void(userData.weither_icon=e.weather[0].icon.slice(0,2)))}).fail(function(){console.log("fail"),userData.temp="未知"}).always(function(){console.log("done"),userData.img=$(".thumb").attr("src"),"1pxgray.png"==userData.img&&(userData.img="http://static.vgee.cn/photo"+Math.ceil(PICS*Math.random())+".png?imageView2/2/w/500/interlace/0/q/90"),e(userData)})})},postData=function(e){userData.message=userData.message.replace(/\n/g,"/_rt/"),userData.img=userData.img.split("?")[0],$.post(API.post,userData).success(function(t){e.waiting=!1,1==t.flag?window.location.href="list.html":(console.log(t),alert(JSON.stringify(t)))})},init=function(){$("#msg").textareaAutoSize().focus(),$(".submit").click(function(e){e.preventDefault();var t=Cookies.get("user");return t||(t=window.prompt("你叫什么呢？（小于10个字符)",""),t||(t=window.prompt("别淘气，你叫啥？","")),t.length>10&&(t=window.prompt("名字太非主流不好（小于10个字符)",t)),Cookies.set("user",t,{expires:1e3,path:"/"})),$(".edit #msg").val()?($(this).addClass("circle"),void loadUserMsg(function(e){userData.author=t,$(this).removeClass("circle"),$(".edit").toHide().one(transitionend,function(){$(this).unbind(transitionend).hide(),$(".preview").show().find("#prepre").text(userData.message).end().find("#picture").attr("src",userData.img).end().find("#i-temp").html(icons[userData.weither_icon]).end().find("#temp").text(userData.weither).end().find("#time").text(userData.time).end().find("#loc").text(userData.city).end().find(".user span").text(userData.author).end(),setTimeout(function(){$(".preview").toShow()})}),console.log(userData)}.bind(this))):void alert("总得说点什么吧")}),$(".ret").click(function(){$(".preview").toHide().one(transitionend,function(){$(this).unbind(transitionend).hide(),$(".edit").show(),setTimeout(function(){$(".edit").toShow()})})}),$(".go").click(function(){this.waiting||(this.waiting=!0,postData(this))}),$("#picture").click(function(){userData.img="http://static.vgee.cn/photo"+Math.ceil(PICS*Math.random())+".png?imageView2/2/w/500/interlace/0/q/90",$(this).attr("src",userData.img)})},guid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,i="x"==e?t:3&t|8;return i.toString(16)})},previewImage=function(e,t){if(e&&/image\//.test(e.type))if("image/gif"==e.type){var i=new mOxie.FileReader;i.onload=function(){t(i.result),i.destroy(),i=null},i.readAsDataURL(e.getSource())}else{var a=new mOxie.Image;a.onload=function(){a.downsize(1e3,2e3);var e="image/jpeg"==a.type?a.getAsDataURL("image/jpeg",80):a.getAsDataURL();t&&t(e),a.destroy(),a=null},a.load(e.getSource())}};plupload.addFileFilter("limit_sharp",function(e,t,i){if(!e)return void i(!0);if("[object Array]"!==Object.prototype.toString.call(e))return void i(!0);var a=e[0],o=e[1],n=e[2],s=a/o,r=this,c=new mOxie.Image;c.load(t.getSource()),c.onload=function(){l(c)},c.onerror=function(){l(!1)};var l=function(e){if(!e)return void i(!1);console.log(e.width),console.log(e.height);var c=e.width/e.height,l=Math.abs(s-c);l>.01?(r.trigger("Error",{code:-888,message:"File sharp error.",file:t,img:{width:a,height:o}}),i(!1)):n&&e.width<n?(r.trigger("Error",{code:-889,message:"File size too small.",file:t,img:{width:a,height:o}}),i(!1)):i(!0)}}),initUploader=function(e,t,i,a,o){var n=t.policy,s=new plupload.Uploader({runtimes:"html5,flash,silverlight,html4",browse_button:$(e).find(".mask")[0],container:e,resize:{width:1e3,height:2e3,quality:90,crop:!1},flash_swf_url:"plupload/Moxie.swf",silverlight_xap_url:"plupload/Moxie.xap",url:n.host,multi_selection:!1,multipart_params:{policy:n.policyBase64,OSSAccessKeyId:n.accessid,success_action_status:"200",signature:n.signature,callback:n.callback},filters:{mime_types:[{title:"Image files",extensions:"jpg,jpeg,png,gif"}],max_file_size:i,limit_sharp:a},init:{PostInit:function(){this._$ele=$(e),this._$imgCt=this._$ele.find(".img-ct"),this._$thumb=this._$ele.find(".thumb"),this._$count=this._$ele.find(".iconfont")},FilesAdded:function(e,t){this._$ele.addClass("uploading"),this._filename=guid()+".jpg",e.setOption({multipart_params:{Filename:this._filename,key:this._filename,policy:n.policyBase64,OSSAccessKeyId:n.accessid,success_action_status:"200",signature:n.signature,callback:n.callback}});var i=this;console.log("files"),console.log(t),plupload.each(t,function(e){previewImage(e,function(e){i._$thumb.attr("src",e),$(".container.edit .pic-ct").css("height","auto")}),s.start()})},UploadProgress:function(e,t){this._$count.text(t.percent.toFixed(0)+"%")},FileUploaded:function(e,t,i){this._$ele.removeClass("uploading"),this._$count.remove(),i.status>=200||i.status<200?(console.log("done"),this._$thumb.attr("src",n.host+"/"+this._filename),o(i)):console.log(i.response)},Error:function(e,t){this._$ele.removeClass("uploading");var i={};-888==t.code?i.text="请选择分辨率为 "+t.img.width+" * "+t.img.height+" 的图片":-889==t.code?i.text="请选择分辨率为 "+t.img.width+" * "+t.img.height+" 的图片":-600==t.code?i.text="图片大小超出限制":-601==t.code?i.text="文件格式错误":-200==t.code?i.text="上传错误，请重试":i.text=t.message,console.log(t)}}});s.init()},$(function(){init(),$.get(API.policy).success(function(e){return 1!=e.flag?(console.log(e),void alert("暂时无法上传图片!")):void initUploader($(".pic-ct")[0],e,"2048kb",!1,function(e){console.log("success")})})});